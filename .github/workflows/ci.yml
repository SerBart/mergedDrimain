name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-backend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Run backend tests
      run: ./mvnw clean verify
      
    - name: Upload test results on failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-results
        path: |
          target/surefire-reports/
          target/failsafe-reports/
        retention-days: 30
      
  test-frontend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 'stable'
        channel: 'stable'
        
    - name: Cache Flutter dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          frontend/.dart_tool
        key: ${{ runner.os }}-flutter-${{ hashFiles('frontend/pubspec.yaml') }}
        restore-keys: ${{ runner.os }}-flutter-
        
    - name: Install Flutter dependencies
      run: |
        cd frontend
        flutter pub get
        
    - name: Analyze Flutter code
      run: |
        cd frontend
        flutter analyze
        
    # Conditional Flutter tests - only run if test directory exists and has tests
    - name: Check for Flutter tests
      id: check-tests
      run: |
        if [ -d "frontend/test" ] && [ "$(find frontend/test -name "*.dart" | wc -l)" -gt 0 ]; then
          echo "has-tests=true" >> $GITHUB_OUTPUT
        else
          echo "has-tests=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Run Flutter tests
      if: steps.check-tests.outputs.has-tests == 'true'
      run: |
        cd frontend
        flutter test
        
  build-and-deploy:
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 'stable'
        channel: 'stable'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Cache Flutter dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          frontend/.dart_tool
        key: ${{ runner.os }}-flutter-${{ hashFiles('frontend/pubspec.yaml') }}
        restore-keys: ${{ runner.os }}-flutter-
        
    - name: Build Flutter web
      run: |
        cd frontend
        flutter pub get
        flutter build web --release --dart-define=API_BASE=http://localhost:8080
        
    - name: Copy Flutter build to static resources
      run: |
        rm -rf src/main/resources/static/*
        cp -r frontend/build/web/* src/main/resources/static/
        
    - name: Build Spring Boot application
      run: ./mvnw clean package -DskipTests
      
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: spring-boot-jar
        path: target/*.jar
        retention-days: 30
        
    - name: Upload Flutter web build
      uses: actions/upload-artifact@v4
      with:
        name: flutter-web-build
        path: frontend/build/web/**
        retention-days: 30
        
    - name: Upload static resources
      uses: actions/upload-artifact@v4
      with:
        name: integrated-static-resources
        path: src/main/resources/static/**
        retention-days: 30